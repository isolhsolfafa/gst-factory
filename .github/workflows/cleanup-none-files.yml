name: Clean up NONE JSON files

on:
  schedule:
    # ë§¤ì¼ ì˜¤í›„ 1ì‹œ (KST ê¸°ì¤€, UTC 04:00)ì— ì‹¤í–‰
    - cron: '0 4 * * *'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      dry_run:
        description: 'Dry run (ì‚­ì œí•˜ì§€ ì•Šê³  í™•ì¸ë§Œ)'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  cleanup-none-files:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # ì „ì²´ ížˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°
    
    - name: Find NONE JSON files
      id: find-files
      run: |
        echo "=== NONE JSON íŒŒì¼ ê²€ìƒ‰ ===" 
        
        # public/daily_data ë””ë ‰í† ë¦¬ì—ì„œ NONE_*.json íŒŒì¼ ì°¾ê¸°
        NONE_FILES=$(find public/daily_data -name "NONE_*.json" 2>/dev/null || echo "")
        
        if [ -z "$NONE_FILES" ]; then
          echo "ì‚­ì œí•  NONE JSON íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
          echo "files_found=false" >> $GITHUB_OUTPUT
          echo "file_list=" >> $GITHUB_OUTPUT
        else
          echo "ë°œê²¬ëœ NONE JSON íŒŒì¼ë“¤:"
          echo "$NONE_FILES"
          echo "files_found=true" >> $GITHUB_OUTPUT
          echo "file_list<<EOF" >> $GITHUB_OUTPUT
          echo "$NONE_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # íŒŒì¼ ê°œìˆ˜ ì„¸ê¸°
          FILE_COUNT=$(echo "$NONE_FILES" | wc -l)
          echo "ì´ $FILE_COUNT ê°œì˜ NONE JSON íŒŒì¼ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤."
        fi
    
    - name: Backup NONE files (before deletion)
      if: steps.find-files.outputs.files_found == 'true'
      run: |
        echo "=== NONE JSON íŒŒì¼ ë°±ì—… ===" 
        
        # ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p backup/none_files_$(date +%Y%m%d_%H%M%S)
        BACKUP_DIR="backup/none_files_$(date +%Y%m%d_%H%M%S)"
        
        # NONE íŒŒì¼ë“¤ì„ ë°±ì—… ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬
        while IFS= read -r file; do
          if [ -f "$file" ]; then
            cp "$file" "$BACKUP_DIR/"
            echo "ë°±ì—…ë¨: $file -> $BACKUP_DIR/"
          fi
        done <<< "${{ steps.find-files.outputs.file_list }}"
        
        echo "ë°±ì—… ì™„ë£Œ: $BACKUP_DIR"
    
    - name: Upload backup as artifact
      if: steps.find-files.outputs.files_found == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: none-files-backup-${{ github.run_number }}
        path: backup/none_files_*
        retention-days: 30
    
    - name: Delete NONE JSON files (dry run)
      if: steps.find-files.outputs.files_found == 'true' && github.event.inputs.dry_run == 'true'
      run: |
        echo "=== DRY RUN: ì‚­ì œë  íŒŒì¼ë“¤ ===" 
        echo "ë‹¤ìŒ íŒŒì¼ë“¤ì´ ì‚­ì œë  ì˜ˆì •ìž…ë‹ˆë‹¤:"
        echo "${{ steps.find-files.outputs.file_list }}"
        echo ""
        echo "ì‹¤ì œ ì‚­ì œë¥¼ ì›í•˜ë©´ dry_runì„ falseë¡œ ì„¤ì •í•˜ì—¬ ë‹¤ì‹œ ì‹¤í–‰í•˜ì„¸ìš”."
    
    - name: Delete NONE JSON files
      if: steps.find-files.outputs.files_found == 'true' && github.event.inputs.dry_run != 'true'
      run: |
        echo "=== NONE JSON íŒŒì¼ ì‚­ì œ ì‹œìž‘ ===" 
        
        DELETED_COUNT=0
        while IFS= read -r file; do
          if [ -f "$file" ]; then
            echo "ì‚­ì œ ì¤‘: $file"
            rm "$file"
            DELETED_COUNT=$((DELETED_COUNT + 1))
          else
            echo "íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: $file"
          fi
        done <<< "${{ steps.find-files.outputs.file_list }}"
        
        echo "ì´ $DELETED_COUNT ê°œì˜ NONE JSON íŒŒì¼ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤."
    
    - name: Commit and push changes
      if: steps.find-files.outputs.files_found == 'true' && github.event.inputs.dry_run != 'true'
      run: |
        echo "=== Git ì»¤ë°‹ ë° í‘¸ì‹œ ===" 
        
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # ë³€ê²½ì‚¬í•­ì´ ìžˆëŠ”ì§€ í™•ì¸
        if git diff --quiet; then
          echo "ì‚­ì œí•  íŒŒì¼ì´ ì—†ê±°ë‚˜ ì´ë¯¸ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."
        else
          git add -A
          git commit -m "ðŸ—‘ï¸ Auto cleanup: Remove NONE_*.json files [$(date +'%Y-%m-%d %H:%M:%S')]"
          git push
          echo "ë³€ê²½ì‚¬í•­ì´ ì»¤ë°‹ë˜ê³  í‘¸ì‹œë˜ì—ˆìŠµë‹ˆë‹¤."
        fi
    
    - name: Summary
      if: always()
      run: |
        echo "=== ì •ë¦¬ ìž‘ì—… ì™„ë£Œ ===" 
        if [ "${{ steps.find-files.outputs.files_found }}" == "true" ]; then
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "âœ… DRY RUN ì™„ë£Œ: ì‚­ì œë  íŒŒì¼ ëª©ë¡ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤."
          else
            echo "âœ… NONE JSON íŒŒì¼ ì •ë¦¬ ì™„ë£Œ"
            echo "ðŸ“¦ ë°±ì—…ì´ ì•„í‹°íŒ©íŠ¸ë¡œ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤ (30ì¼ ë³´ê´€)"
          fi
        else
          echo "â„¹ï¸  ì‚­ì œí•  NONE JSON íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
        fi
